stages:
  - lint
  - test
  - build
  - publish

commitlint:
  stage: lint
  image: alpine:3.19
  before_script:
    - apk add --no-cache git
  script:
    - |
      set -euo pipefail
      base_ref="${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-${CI_DEFAULT_BRANCH:-main}}"
      git fetch origin "$base_ref"
      if [ -n "${CI_COMMIT_TAG:-}" ]; then
        range="${CI_COMMIT_SHA}^..${CI_COMMIT_SHA}"
      elif [ -n "${CI_MERGE_REQUEST_IID:-}" ]; then
        range="${base_ref}..${CI_COMMIT_SHA}"
      elif [ "${CI_COMMIT_BEFORE_SHA:-0000000000000000000000000000000000000000}" = "0000000000000000000000000000000000000000" ]; then
        range="${CI_COMMIT_SHA}"
      else
        range="${CI_COMMIT_BEFORE_SHA:-$base_ref}..${CI_COMMIT_SHA}"
      fi
      commits="$(git log --format='%s' "${range}")"
      if [ -z "$commits" ]; then
        echo "No commits to lint"
        exit 0
      fi
      echo "$commits" | sed '/^$/d'
      if echo "$commits" | grep -Ev '^(feat|fix|chore|docs|refactor|test|build|ci|revert)(\(.+\))?(!)?: ' >/dev/null; then
        echo "Commit messages must follow conventional commits"
        exit 1
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'

python_test:
  stage: test
  image: python:3.12-alpine
  script:
    - |
      set -euo pipefail
      python -m pip install --upgrade pip
      python -m pip install -r requirements.txt
      python -m py_compile botads/*.py examples/fastapi/main.py examples/telegram_bot/main.py
      python -m unittest discover -s tests -p "test*.py"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG'

python_build:
  stage: build
  image: python:3.12-alpine
  script:
    - |
      set -euo pipefail
      python -m pip install --upgrade pip
      python -m pip install build
      python -m build
  artifacts:
    paths:
      - dist/*
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG'

pypi_publish:
  stage: publish
  image: python:3.12-alpine
  needs:
    - job: python_build
      artifacts: true
  script:
    - |
      set -euo pipefail
      python -m pip install --upgrade pip
      python -m pip install twine
      export TWINE_USERNAME="__token__"
      export TWINE_PASSWORD="${PYPI_TOKEN}"
      python -m twine upload --non-interactive dist/*
  rules:
    - if: '$CI_COMMIT_TAG && $PYPI_TOKEN'
